{% extends "coachreports/base.html" %}
{% comment %}
This template is a basic skeleton around a Google Visualization plot.  It has the following parts:

* Loads scripts necessary for Google Visualizations (locally)
* Has a div for plotting, and a div for status message (loading)

You must:
* Implement js function drawJsonChart(chart_div, json, xaxis, yaxis);
    - Get a JSON blob
    - Create the visualization chart and options
    - Dump to the chart div (by default: chart_div)
* Implement template block axis_dropdown that contains:
        <select id="xaxis" name="xaxis">
            <option value="">----</option>
            [other options with value=API key for that value, and nice text for it (via common views.py code)
        <select id="yaxis" name="yaxis">
            <option value="">----</option>
            [other options with value=API key for that value, and nice text for it (via common views.py code)
{% endcomment %}

{% load my_filters %}
{% load staticfiles %}


{% block headjs %}
<!-- Necessary for Google -->
<script type="text/javascript" src="/static/js/coachreports/google.jsapi.js"></script>
<script type="text/javascript">
//  google.load("visualization", "1", {packages:["corechart"]});
if (window['google'] != undefined && window['google']['loader'] != undefined) {
    if (!window['google']['visualization']) {
        window['google']['visualization'] = {};
        google.visualization.Version = '1.0';
        google.visualization.JSHash = '4c2447db544d51e9c1e1331ad8007df0';
        google.visualization.LoadArgs = 'file\75visualization\46v\0751\46packages\75corechart';
    }
    google.loader.writeLoadTag("script", "/static/js/coachreports/google.corechart.js", false);
}
</script>
<script type="text/javascript" src="/static/js/coachreports/google.jsapi.js"></script>

<script src="{% static "js/jquery-ui.custom.min.js" %}"></script>
<script src="{% static "js/jquery.dynatree.min.js" %}"></script>

<script type="text/javascript">

function plotJsonData(chart_div, base_url, topic_path, xaxis, yaxis) {
    /* Called whenever json data blob returns (via AJAX)
       NOTE: you have to implement drawJsonChart(chart_div, json, xaxis, yaxis); */
    
    //
    if (xaxis && xaxis != $("#xaxis option:selected").val()) {
        $("#xaxis").val(xaxis);
    }
    if (yaxis && yaxis != $("#yaxis option:selected").val()) {
        $("#yaxis").val(yaxis);
    }
    if (!xaxis || !yaxis) { // one of the ---- is selected
        return false; 
    }
    
    // Get the data
    var url = base_url + "?facility_id={{ form.facility_id }}&group_id={{ form.group_id }}&user_id={{ form.user_id }}";
    url += ("&xaxis=" + xaxis + "&yaxis=" + yaxis);
    
    for (var i in topic_path){
        url += "&topic_path=" + topic_path[i];
    }

    $.getJSON(url, function(json) {
        window.json = json;
        
        $("#loading").text("Drawing " + xaxis + " " + yaxis); 
        drawJsonChart(chart_div, json, xaxis, yaxis);
        $("#loading").text(""); 
    }).fail(function(data) {
        $("#loading").text("Failure (" + data.status + "): " + data.responseText); 
    });
    $("#loading").text("Loading " + xaxis + " " + yaxis); 
}
</script>
{% endblock headjs %}


{% block headcss %} {{ block.super }}
<link rel='stylesheet' type='text/css' href='{% static "css/coachreports/google.tooltip.css" %}'>
<link href="{% static "css/ui.dynatree.css" %}" rel="stylesheet" type="text/css"/>
<style>
#loading {
    width:100%;
    font-size:12pt;
    text-align:center;
}
.google-chart {
    width: 900px; 
    height: 500px;
}
#content_tree_toggle .open {
    display: none;
}
</style>
{% endblock headcss %}



{% block content %}
    
<h2 class="main-headline">{% block headline %}{% endblock headline %}</h2>

{% block navbar %}{{ block.super }}{% endblock navbar %}

<div id="choose">
    <form id="select_data" name="select_data">
{% block axis_dropdown %}
[You must fill me in!!]
    {% block data_options %}
            <option value="">----</option>
        {% mkrange 0 5 as option_range %}
        {% for oi in option_range %}
            {% cycle "pct_mastery" "effort" "ex:attempts"    "ex:streak_progress"      "ex:points"       as option_value silent %}
            {% cycle "% Mastery"   "Effort" "Total Attempts" "Average Streak" "Exercise Points" as option_text  silent %}
            <option value="{{ option_value}}"{% if option_value = form|get_item:axis_value %} selected{% endif %}>{{ option_text }}</option>
        {% endfor %}
    {% endblock data_options %}
{% endblock axis_dropdown %}
    </form>
</div>

<div id="content_tree"><br/><h2>Loading topic tree... Please wait!</h2></div>
<button id="content_tree_toggle"><span class="open">Select topics</span><span class="close">Use selected topics</span></button>

<div id="google-chart">
{% block chart_div %}
    <div id="loading"></div>
    <div id="chart_div" class="google-chart"></div>
{% endblock chart_div %}
</div>

<script type="text/javascript">
{% mkrange 0 2 as axes_range %}
{% for ai in axes_range %}
    {% cycle "xaxis"  "yaxis"  as axis_value silent %}
    $("#{{ axis_value }}").change(function(){
        plotJsonData(
            "#chart_div",
            "{% url api_data %}",
            {{ form.topic_path|jsonify }}, 
            $("#xaxis option:selected").val(),
            $("#yaxis option:selected").val()
        );
    });
{% endfor %}

    function plotTopics(topics) {
        plotJsonData(
            "#chart_div",
            "{% url api_data %}",
            {{ form.topic_path|jsonify }},
            "{{ form.xaxis }}", 
            "{{ form.yaxis }}"
        );
    }

    $(function() {        
        
        setTimeout(function() {
            doRequest("/coachreports/api/get_math_topic_tree", {}).success(function(treeData) {
                
                $("#content_tree").dynatree({
                    imagePath:"../images/",
                    checkbox: true,
                    selectMode: 3,
                    children: treeData,
                    debugLevel: 0,
                    onSelect: function(select, node) {
                        
                    },
                    onDblClick: function(node, event) {
                        node.toggleSelect();
                    },
                    onKeydown: function(node, event) {
                        if( event.which == 32 ) {
                            node.toggleSelect();
                            return false;
                        }
                    },
                    onPostInit: function() {

                    }
                });
                        
            });
        }, 200);

        // open and close the topic tree, and call `display_selected_topics` when closed
        var showing_tree = false;
        $("#content_tree_toggle").click(function() {
            showing_tree = !showing_tree;
            $("#content_tree_toggle span").toggle();
            $("#content_tree").slideToggle();
            if (!showing_tree && _.isFunction(display_selected_topics)) {
                display_selected_topics(get_topic_prefixes_from_tree());
            }
        });

        function get_topic_prefixes_from_tree() {
            var paths = [];
            $.each($("#content_tree").dynatree("getSelectedNodes"), function(ind, node) {
                if (!node.parent.parent || !node.parent.bSelected) {
                    paths.push(node.data.key);
                }
            });
            return paths;
        }

    });

</script>
{% endblock content %}
